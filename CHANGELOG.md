# Changelog

未来便（Mirai-bin）の変更履歴

## [2025-01-07] - アカウント引き継ぎ対策と関係性拡張

### 追加機能

#### 1. 関係性の拡張
- **将来の自分へのタイムカプセル**: 関係性に「自分」を追加し、将来の自分に向けた手紙を作成可能に
- **親から子への手紙**: 関係性に「親」を追加し、親から子への逆方向の手紙にも対応

#### 2. アカウントメール変更機能
- **API実装**: `user.updateEmail` APIを追加
- **UI実装**: 設定画面でアカウントメールアドレスを変更可能に
- **簡易変更**: 現在は即座変更（将来的には確認メール送信フローを追加予定）

#### 3. アカウント引き継ぎ・復旧ガイド
- **新規ページ**: `/account-recovery` ページを作成
- **保管すべき情報**: 解錠コード、共有リンク、アカウント情報の説明
- **推奨保管場所**: 銀行貸金庫、遺言書、パスワード管理ツールなどの具体例
- **配偶者・家族への説明文**: コピー可能な引き継ぎ手順テンプレート
- **FAQ形式**: アカウント喪失時の対処法を質問形式で解説
- **設定画面からのリンク**: 設定画面に引き継ぎガイドへのリンクを追加

### 技術的変更

#### バックエンド
- `server/db.ts`: `updateUserEmail` 関数を追加
- `server/routers.ts`: `user.updateEmail` APIエンドポイントを追加
- `server/letter.test.ts`: メール変更APIの認証テストを追加

#### フロントエンド
- `client/src/pages/CreateLetter.tsx`: 関係性選択に「自分」「親」を追加
- `client/src/pages/Settings.tsx`: アカウントメール変更UIを追加
- `client/src/pages/AccountRecovery.tsx`: 引き継ぎ手順ページを新規作成
- `client/src/App.tsx`: `/account-recovery` ルーティングを追加

### テスト
- 全68件のテストがパス
- `user.updateEmail` APIの認証テストを追加

---

## [2025-01-07] - 開封日・通知スケジュールの変更機能

### 追加機能

#### スケジュール変更機能
- **開封日時の変更**: 手紙作成後も開封日時を変更可能に
- **リマインダー設定の変更**: 90/30/7/1日前の通知を後から変更可能
- **送信済みリマインダー保持**: 既に送信されたリマインダーは変更時も保持
- **開封済み保護**: 既に開封された手紙はスケジュール変更不可

### 技術的変更

#### バックエンド
- `server/routers.ts`: `letter.updateSchedule` APIを追加
- `server/db.ts`: `updateLetterReminders` 関数を改善（送信済みリマインダー保持）

#### フロントエンド
- `client/src/pages/LetterDetail.tsx`: スケジュール編集UIを追加
  - 開封日時picker（datetime-local）
  - リマインダーON/OFF切り替え
  - daysBefore選択（90/30/7/1日前）
  - 開封済みの場合は編集不可表示

### テスト
- 全66件のテストがパス
- 送信済みリマインダー保持テストを追加
- スケジュール変更時のscheduledAt再計算テストを追加

---

## [2025-01-06] - 共有リンクの失効・再発行機能

### 追加機能

#### 共有リンク管理
- **共有リンクの無効化**: 既存の共有リンクを無効化可能
- **共有リンクの再発行**: 新しい共有リンクを生成し、旧リンクを自動無効化
- **レガシーマイグレーション**: 既存の `letters.shareToken` から新テーブルへの自動移行

### 技術的変更

#### データベース
- `letterShareTokens` テーブルを追加
  - `status`: active | revoked | rotated
  - `replacedByToken`: ローテーション時の新トークン参照
  - `viewCount`, `lastAccessedAt`: アクセス統計

#### バックエンド
- `server/db.ts`: 共有トークン管理関数を追加
  - `createShareToken`, `revokeShareToken`, `rotateShareToken`
  - `migrateShareTokenIfNeeded`: レガシーマイグレーション
- `server/routers.ts`: 共有リンク管理APIを追加
  - `letter.revokeShareLink`, `letter.rotateShareLink`

#### フロントエンド
- `client/src/pages/LetterDetail.tsx`: 共有リンク管理UIを追加
  - 無効化ボタン（確認ダイアログ付き）
  - 再発行ボタン（確認ダイアログ付き）
  - 無効化後の「共有停止中」表示

### テスト
- 共有トークンのライフサイクルテストを追加
- active/revoked/rotated状態のテスト
- レガシーマイグレーションのテスト

---

## 初期リリース機能

### コア機能
- 音声録音（90秒制限）
- 音声文字起こし（Whisper API）
- AI下書き生成（LLM統合）
- クライアント側暗号化（AES-GCM-256）
- ゼロ知識設計（サーバーは暗号文のみ保持）
- Shamir秘密分散（3シェア中2シェア必要）
- OpenTimestamps証跡機能
- 共有リンク機能
- PWA対応（オフライン下書き保存）

### テンプレート
- 30種類のテンプレート（人生の節目、感情サポート、親の本音、儀式）
- カテゴリ分類とフィルタリング
- アコーディオン方式のUI

### セキュリティ
- 解錠コード自動生成（62^12エントロピー）
- 開封日時制限（サーバー側で強制）
- 初回開封通知
- X日前リマインダー通知（90/30/7/1日前）

### 法務・運用
- プライバシーポリシー
- 利用規約
- よくある質問（FAQ）
- 使い方ガイド
